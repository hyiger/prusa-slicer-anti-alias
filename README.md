# PrusaSlicer Z Anti-Aliasing Post-Processor

Implements a practical version of sub-layer toolpath Z "anti-aliasing" by vertically raycasting into the original STL
and adding small Z offsets to extrusion moves. Inspired by *Anti-aliasing for fused filament deposition* (Song et al., 2017). fileciteturn0file0

## Usage (PrusaSlicer)

In **Print Settings → Output options → Post-processing scripts**, add:

```bash
python3 /path/to/prusaslicer_anti_alias_z.py "$GCODE"
```

Place the STL next to the G-code, or pass it explicitly:

```bash
python3 /path/to/prusaslicer_anti_alias_z.py "$GCODE" --stl /path/to/model.stl
```

### Options

- `- `--max-dz-frac 0.5` clamps dz to ±(layer HEIGHT * frac), default 0.5 (±h/2)
- `--include-type "External perimeter"` (repeatable) to control which PrusaSlicer `;TYPE:` regions are modified
- `--include-infill` also modifies `Solid infill` and `Infill`
- `--enable-first-layer` enables modification on first layer (off by default)

## Notes

- This script assumes the STL is in the same coordinate frame as the G-code (no rotation/translation in the slicer).
- Works best on `External perimeter`, `Perimeter`, and `Top solid infill` (defaults).
- Does **not** reorder paths or do overlap compensation (kept intentionally simple).

## Dev

```bash
pip install -r requirements.txt
pytest -q
```

## Binary G-code (.bgcode)

This script **does not support Prusa binary G-code (.bgcode)**.

If binary G-code is enabled, the script will exit with a clear error message.
Disable **Printer Settings → General → Use binary G-code**, then re-slice
to generate standard text G-code before using this post-processing script.


## Nozzle diameter detection

PrusaSlicer does **not** provide nozzle diameter as a post-processing placeholder. This script therefore
**auto-detects nozzle diameter from the G-code header** generated by PrusaSlicer, which contains a line like:

```
; nozzle_diameter = 0.4
```

The detected value is used for resampling and geometric limits.

### Manual override (optional)

You can still pass `the auto-detected value.

## STL requirement

This post-processing script needs access to the original STL to raycast the surface.
If the STL cannot be found, the script will exit with a clear error message.
When using PrusaConnect (which uses temporary G-code paths), passing `--stl /path/to/model.stl`
is the most reliable workflow.

## PrusaSlicer post-processing behavior (important)

PrusaSlicer may run post-processing scripts in a hybrid mode:

- The generated G-code may be piped to stdin
- One or more temporary filenames may be appended as extra arguments (some builds append a `.gcode.pp` path)

This script supports both modes:

- If a G-code path is provided, it reads from disk and overwrites that file by default.
- If no path is provided, it reads from stdin and writes to stdout.

### Recommended PrusaSlicer command (macOS + Homebrew Python)

```bash
/opt/homebrew/bin/python3 /Users/rlewis/prusa-slicer-anti-alias-z/prusaslicer_anti_alias_z.py "${GCODE}"
```

If PrusaSlicer runs the script in stdin mode, pass the STL explicitly:

```bash
/opt/homebrew/bin/python3 /Users/rlewis/prusa-slicer-anti-alias-z/prusaslicer_anti_alias_z.py "${GCODE}" --stl "/path/to/model.stl"
```
